<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WIN88 Â· ç™¾å®¶ä¹</title>
  <link rel="stylesheet" href="casino.css"/>
</head>
<body class="app">

<header class="appbar">
  <button class="iconBtn" onclick="location.href='index.html'">â€¹</button>
  <div class="brandCenter">
    <div class="brandMark">ğŸ´</div>
    <div class="brandText">Baccarat</div>
  </div>
  <button class="iconBtn" onclick="location.href='vip.html'">ğŸ‘‘</button>
</header>

<main class="container">

  <section class="walletCard">
    <div class="walletTop">
      <div class="walletTitle">Balance</div>
      <div class="walletActions">
        <button class="pillBtn" onclick="repeatBet()">Repeat</button>
        <button class="pillBtn" onclick="clearBet()">Clear</button>
        <button class="pillBtn" onclick="doubleBet()">Double</button>
      </div>
    </div>
    <div class="walletBottom">
      <div class="balancePill">
        <span class="ccy">COIN</span>
        <span class="amt" id="coin">â€”</span>
      </div>
      <button class="syncBtn" onclick="deal()">Deal</button>
    </div>
    <div class="subRow">
      <div class="muted" id="tip">é€‰æ‹©ç­¹ç å¹¶ä¸‹æ³¨ï¼ˆå¨±ä¹å¸ï¼‰</div>
    </div>
  </section>

  <section class="walletCard" style="margin-top:12px">
    <div class="walletTop">
      <div class="walletTitle">Chips</div>
      <div class="walletActions" style="gap:8px">
        <button class="tab" onclick="setChip(10)">10</button>
        <button class="tab" onclick="setChip(50)">50</button>
        <button class="tab active" id="chip100" onclick="setChip(100)">100</button>
        <button class="tab" onclick="setChip(500)">500</button>
        <button class="tab" onclick="setChip(1000)">1000</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
      <div class="providerCard" onclick="addBet('player')" style="cursor:pointer">
        <div class="providerLeft">
          <div class="providerLogo">PLAYER</div>
          <div class="providerName">é—² 1:1</div>
          <div class="muted">Bet: <b id="bet_player">0</b></div>
        </div>
      </div>

      <div class="providerCard" onclick="addBet('banker')" style="cursor:pointer">
        <div class="providerLeft">
          <div class="providerLogo">BANKER</div>
          <div class="providerName">åº„ 0.95:1</div>
          <div class="muted">Bet: <b id="bet_banker">0</b></div>
        </div>
      </div>

      <div class="providerCard" onclick="addBet('tie')" style="cursor:pointer">
        <div class="providerLeft">
          <div class="providerLogo">TIE</div>
          <div class="providerName">å’Œ 8:1</div>
          <div class="muted">Bet: <b id="bet_tie">0</b></div>
        </div>
      </div>

      <div class="providerCard" onclick="addBet('ppair')" style="cursor:pointer">
        <div class="providerLeft">
          <div class="providerLogo">P PAIR</div>
          <div class="providerName">é—²å¯¹ 11:1</div>
          <div class="muted">Bet: <b id="bet_ppair">0</b></div>
        </div>
      </div>

      <div class="providerCard" onclick="addBet('bpair')" style="cursor:pointer">
        <div class="providerLeft">
          <div class="providerLogo">B PAIR</div>
          <div class="providerName">åº„å¯¹ 11:1</div>
          <div class="muted">Bet: <b id="bet_bpair">0</b></div>
        </div>
      </div>

      <div class="providerCard" style="cursor:default">
        <div class="providerLeft">
          <div class="providerLogo">ROAD</div>
          <div class="providerName">æœ€è¿‘ 20 å±€</div>
          <div id="road" class="muted" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px"></div>
        </div>
      </div>
    </div>
  </section>

  <section class="walletCard" style="margin-top:12px">
    <div class="walletTop">
      <div class="walletTitle">Cards</div>
      <div class="walletActions"><button class="linkBtn" onclick="location.reload()">Reset UI</button></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
      <div class="rowLine">
        <span><b>PLAYER</b></span>
        <span id="pCards">â€”</span>
        <b id="pPoint">0</b>
      </div>
      <div class="rowLine">
        <span><b>BANKER</b></span>
        <span id="bCards">â€”</span>
        <b id="bPoint">0</b>
      </div>
    </div>

    <div style="margin-top:10px" class="muted" id="result">ç­‰å¾…ä¸‹æ³¨</div>
  </section>

  <p class="legal">18+ å¨±ä¹ç”¨é€” Â· è™šæ‹Ÿå¨±ä¹å¸ Â· æ— çœŸå®èµŒåš/æ— å…‘ç°</p>
</main>

<script type="module">
import { getCoin, setCoin, onPlay, vipParams } from "./progress.js";

let coin = getCoin();
const coinEl = document.getElementById("coin");

let chip = 100;
const bets = { player:0, banker:0, tie:0, ppair:0, bpair:0 };
let lastBets = { ...bets };

const roadKey = "road_baccarat20";
let road = JSON.parse(localStorage.getItem(roadKey) || "[]"); // 'P' 'B' 'T'

function saveCoin(){ setCoin(coin); coinEl.textContent = coin; }
function renderBets(){
  for(const k of Object.keys(bets)){
    document.getElementById("bet_"+k).textContent = bets[k];
  }
}
function renderRoad(){
  const box = document.getElementById("road");
  box.innerHTML = "";
  road.slice(0,20).forEach(x=>{
    const d = document.createElement("span");
    d.textContent = x;
    d.style.display="inline-grid";
    d.style.placeItems="center";
    d.style.width="26px";
    d.style.height="26px";
    d.style.borderRadius="10px";
    d.style.border="1px solid #e6eaf2";
    d.style.background= x==="P" ? "#eef2ff" : x==="B" ? "#fff7ed" : "#ecfeff";
    box.appendChild(d);
  });
}

saveCoin(); renderBets(); renderRoad();

window.setChip = (v)=>{
  chip = v;
  document.querySelectorAll(".tabs .tab").forEach(()=>{});
  document.getElementById("tip").textContent = `å½“å‰ç­¹ç ï¼š${chip}ï¼ˆç‚¹å‡»ä¸‹æ³¨åŒºç´¯åŠ ï¼‰`;
};

window.addBet = (type)=>{
  if(coin < chip){ alert("ä½™é¢ä¸è¶³"); return; }
  bets[type] += chip;
  coin -= chip;
  saveCoin();
  renderBets();
};

window.clearBet = ()=>{
  // é€€å›å…¨éƒ¨ä¸‹æ³¨
  let refund = 0;
  for(const k in bets){ refund += bets[k]; bets[k]=0; }
  coin += refund;
  saveCoin();
  renderBets();
};

window.repeatBet = ()=>{
  // é‡å¤ä¸Šå±€ä¸‹æ³¨ï¼ˆè‹¥ä½™é¢è¶³å¤Ÿï¼‰
  const total = Object.values(lastBets).reduce((a,b)=>a+b,0);
  if(total<=0){ alert("ä¸Šä¸€å±€æ²¡æœ‰ä¸‹æ³¨"); return; }
  if(coin < total){ alert("ä½™é¢ä¸è¶³"); return; }
  for(const k in bets){ bets[k] += lastBets[k]; }
  coin -= total;
  saveCoin();
  renderBets();
};

window.doubleBet = ()=>{
  const total = Object.values(bets).reduce((a,b)=>a+b,0);
  if(total<=0){ alert("è¯·å…ˆä¸‹æ³¨"); return; }
  if(coin < total){ alert("ä½™é¢ä¸è¶³"); return; }
  for(const k in bets){ bets[k] *= 2; }
  coin -= total;
  saveCoin();
  renderBets();
};

// ===== çœŸè¡¥ç‰Œè§„åˆ™ç›¸å…³ =====
const suits = ["â™ ï¸","â™¥ï¸","â™¦ï¸","â™£ï¸"];
function drawCard(){
  const r = Math.floor(Math.random()*13) + 1; // 1..13
  let v = r;
  if(r === 1) v = 1;
  else if(r >= 10) v = 0;
  return { r, v, s: suits[Math.floor(Math.random()*4)] };
}
function cardText(c){
  const map = {1:"A",11:"J",12:"Q",13:"K"};
  const face = map[c.r] || String(c.r);
  return face + c.s;
}
function point(hand){ return hand.reduce((a,c)=>a+c.v,0) % 10; }

function bankerDrawRule(bPoint, pThirdV){
  // åº„è¡¥ç‰Œè§„åˆ™ï¼ˆæ ¸å¿ƒï¼‰
  // bPoint 0-2 å¿…è¡¥ï¼›3 åœ¨ pThird!=8 è¡¥ï¼›4 åœ¨ pThird 2-7 è¡¥ï¼›5 åœ¨ pThird 4-7 è¡¥ï¼›
  // 6 åœ¨ pThird 6-7 è¡¥ï¼›7 åœ
  if(bPoint <= 2) return true;
  if(bPoint === 3) return pThirdV !== 8;
  if(bPoint === 4) return (pThirdV >= 2 && pThirdV <= 7);
  if(bPoint === 5) return (pThirdV >= 4 && pThirdV <= 7);
  if(bPoint === 6) return (pThirdV === 6 || pThirdV === 7);
  return false;
}

window.deal = ()=>{
  const totalBet = Object.values(bets).reduce((a,b)=>a+b,0);
  if(totalBet<=0){ alert("è¯·å…ˆä¸‹æ³¨"); return; }

  // è®°å½•ä¸Šå±€ä¸‹æ³¨ï¼ˆç”¨äº Repeatï¼‰
  lastBets = { ...bets };

  const p = [drawCard(), drawCard()];
  const b = [drawCard(), drawCard()];

  const pPair = (p[0].r === p[1].r);
  const bPair = (b[0].r === b[1].r);

  let pPoint = point(p);
  let bPoint = point(b);

  // è‡ªç„¶èƒœ
  if(!(pPoint>=8 || bPoint>=8)){
    // é—²è¡¥ç‰Œï¼š0-5 è¡¥ï¼Œ6-7 åœ
    let pThird = null;
    if(pPoint <= 5){
      pThird = drawCard();
      p.push(pThird);
      pPoint = point(p);
    }
    // åº„è¡¥ç‰Œ
    if(pThird === null){
      // é—²æ²¡è¡¥ç‰Œï¼šåº„ 0-5 è¡¥ï¼Œ6-7 åœ
      if(bPoint <= 5){
        b.push(drawCard());
        bPoint = point(b);
      }
    }else{
      // é—²æœ‰ç¬¬ä¸‰å¼ ï¼šæŒ‰è§„åˆ™
      if(bankerDrawRule(bPoint, pThird.v)){
        b.push(drawCard());
        bPoint = point(b);
      }
    }
  }

  // æ›´æ–°ç‰Œé¢
  document.getElementById("pCards").textContent = p.map(cardText).join(" ");
  document.getElementById("bCards").textContent = b.map(cardText).join(" ");
  document.getElementById("pPoint").textContent = pPoint;
  document.getElementById("bPoint").textContent = bPoint;

  // èƒœè´Ÿ
  const winMain = (pPoint>bPoint) ? "player" : (bPoint>pPoint) ? "banker" : "tie";
  road.unshift(winMain==="player"?"P":winMain==="banker"?"B":"T");
  road = road.slice(0,20);
  localStorage.setItem(roadKey, JSON.stringify(road));
  renderRoad();

  // æ´¾å½©ï¼ˆå¨±ä¹ï¼‰
  const { winBoost } = vipParams();
  let payout = 0;

  // ä¸»æ³¨
  if(bets.player>0 && winMain==="player") payout += Math.floor(bets.player * 2 * winBoost);
  if(bets.banker>0 && winMain==="banker") payout += Math.floor((bets.banker + bets.banker*0.95) * winBoost); // æœ¬é‡‘+0.95
  if(bets.tie>0 && winMain==="tie") payout += Math.floor((bets.tie + bets.tie*8) * winBoost); // æœ¬é‡‘+8å€

  // å¯¹å­
  if(bets.ppair>0 && pPair) payout += Math.floor((bets.ppair + bets.ppair*11) * winBoost);
  if(bets.bpair>0 && bPair) payout += Math.floor((bets.bpair + bets.bpair*11) * winBoost);

  coin += payout;
  saveCoin();

  // æ¸…ç©ºä¸‹æ³¨
  for(const k in bets) bets[k]=0;
  renderBets();

  // ä»»åŠ¡è¿›åº¦
  const task = onPlay("baccarat");
  const taskText = task.got>0 ? `âœ… ä»»åŠ¡å®Œæˆ +${task.got}` : `ä»»åŠ¡ ${task.plays}/${task.target}`;

  document.getElementById("result").textContent =
    `ç»“æœï¼š${winMain==="player"?"é—²":"åº„/å’Œ".includes(winMain) ? (winMain==="banker"?"åº„":"å’Œ") : winMain}ï½œæ´¾å½© +${payout}ï½œ${taskText}`;
};
</script>
</body>
</html>
