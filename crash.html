<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WIN88 Â· Crash</title>
  <link rel="stylesheet" href="casino.css"/>
</head>
<body class="app">

<header class="appbar">
  <button class="iconBtn" onclick="location.href='index.html'">â€¹</button>
  <div class="brandCenter">
    <div class="brandMark">ğŸ’¥</div>
    <div class="brandText">Crash</div>
  </div>
  <button class="iconBtn" onclick="location.href='vip.html'">ğŸ‘‘</button>
</header>

<main class="container">
  <section class="walletCard">
    <div class="walletTop">
      <div class="walletTitle">Balance</div>
      <div class="walletActions">
        <button class="pillBtn" onclick="location.href='partners.html'">Support</button>
      </div>
    </div>
    <div class="walletBottom">
      <div class="balancePill">
        <span class="ccy">COIN</span>
        <span class="amt" id="coin">â€”</span>
      </div>
      <button class="syncBtn" onclick="start()">Start</button>
    </div>
    <div class="subRow"><div class="muted" id="msg">è®¾ç½®è‡ªåŠ¨æç°å€ç‡ï¼ˆå¯é€‰ï¼‰</div></div>
  </section>

  <section class="walletCard" style="margin-top:12px">
    <div class="walletTop">
      <div class="walletTitle">Auto Cashout</div>
      <div class="walletActions">
        <button class="pillBtn" onclick="setAuto(0)">Off</button>
        <button class="pillBtn" onclick="setAuto(1.50)">1.50x</button>
        <button class="pillBtn" onclick="setAuto(2.00)">2.00x</button>
        <button class="pillBtn" onclick="setAuto(3.00)">3.00x</button>
      </div>
    </div>
    <div class="walletBottom">
      <div class="balancePill" style="min-width:240px">
        <span class="ccy">Auto</span>
        <span class="amt" id="autoText">Off</span>
      </div>
      <button class="syncBtn" onclick="cashout()">Cashout</button>
    </div>
  </section>

  <section class="walletCard" style="margin-top:12px">
    <div class="walletTop">
      <div class="walletTitle">Multiplier</div>
      <div class="walletActions"><button class="linkBtn" onclick="resetHistory()">Reset</button></div>
    </div>
    <div class="rowLine" style="margin-top:10px">
      <span><b>Now</b></span>
      <b id="now" style="font-size:20px">1.00x</b>
      <span id="target" class="muted">â€”</span>
    </div>
    <div class="subRow"><div class="muted" id="hist" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px"></div></div>
  </section>

  <p class="legal">18+ å¨±ä¹ç”¨é€” Â· è™šæ‹Ÿå¨±ä¹å¸ Â· æ— çœŸå®èµŒåš/æ— å…‘ç°</p>
</main>

<script type="module">
import { getCoin, setCoin, onPlay, vipParams } from "./progress.js";

let coin = getCoin();
const coinEl = document.getElementById("coin");
const msgEl = document.getElementById("msg");
const nowEl = document.getElementById("now");
const targetEl = document.getElementById("target");
const autoText = document.getElementById("autoText");
const histEl = document.getElementById("hist");

let running=false, timer=null;
let mult=1.0;
let stake=100;
let auto=0;
let crashPoint=0;

const histKey="crash_hist20";
let hist = JSON.parse(localStorage.getItem(histKey) || "[]");
renderHist();

function save(){ setCoin(coin); coinEl.textContent = coin; }
save();

function sampleCrashPoint(){
  // é¢„è®¾çˆ†ç‚¹ï¼šé‡å°¾åˆ†å¸ƒï¼ˆæ›´åƒçœŸå® crashï¼‰
  // r è¶Šæ¥è¿‘ 1ï¼Œçˆ†ç‚¹è¶Šå¤§
  const r = Math.random();
  const base = 0.99 / (1 - r); // heavy tail
  const capped = Math.min(base, 50); // ä¸Šé™ 50xï¼ˆå¯è°ƒï¼‰
  return Math.max(1.01, Number(capped.toFixed(2)));
}

function renderHist(){
  histEl.innerHTML="";
  hist.forEach(x=>{
    const d=document.createElement("span");
    d.textContent = x.toFixed(2)+"x";
    d.style.display="inline-grid";
    d.style.placeItems="center";
    d.style.width="58px";
    d.style.height="26px";
    d.style.borderRadius="10px";
    d.style.border="1px solid #e6eaf2";
    d.style.background = x<2 ? "#fff7ed" : x<5 ? "#eef2ff" : "#ecfeff";
    histEl.appendChild(d);
  });
}
window.resetHistory=()=>{
  hist=[];
  localStorage.setItem(histKey, JSON.stringify(hist));
  renderHist();
};

window.setAuto=(x)=>{
  auto=x;
  autoText.textContent = auto===0 ? "Off" : auto.toFixed(2)+"x";
};

function tick(){
  // å¢é•¿æ›²çº¿ï¼ˆå‰å¿«åæ…¢ï¼‰
  mult += 0.02 + mult*0.012;
  mult = Number(mult.toFixed(2));
  nowEl.textContent = mult.toFixed(2)+"x";

  // è‡ªåŠ¨æç°
  if(auto>0 && mult >= auto){
    cashout(true);
    return;
  }

  // åˆ°è¾¾çˆ†ç‚¹
  if(mult >= crashPoint){
    boom();
  }
}

function boom(){
  stop();
  msgEl.textContent = `ğŸ’¥ çˆ†äº†ï¼çˆ†ç‚¹ ${crashPoint.toFixed(2)}x`;
  targetEl.textContent = `CRASH @ ${crashPoint.toFixed(2)}x`;
  hist.unshift(crashPoint);
  hist=hist.slice(0,20);
  localStorage.setItem(histKey, JSON.stringify(hist));
  renderHist();

  // ä»»åŠ¡
  const task = onPlay("crash");
  if(task.got>0) msgEl.textContent += ` ï½œâœ…ä»»åŠ¡ +${task.got}`;
}

function stop(){
  running=false;
  if(timer) clearInterval(timer);
  timer=null;
}

window.start=()=>{
  if(running) return;

  const { costFactor } = vipParams();
  const cost = Math.floor(stake * costFactor);
  if(coin < cost){ alert("ä½™é¢ä¸è¶³"); return; }
  coin -= cost; save();

  mult=1.00;
  crashPoint = sampleCrashPoint();

  nowEl.textContent="1.00x";
  targetEl.textContent="â€”";

  running=true;
  msgEl.textContent = `è¿›è¡Œä¸­â€¦ æœ¬å±€æ‰£ ${cost}ï¼Œçˆ†ç‚¹å·²é¢„è®¾`;
  timer=setInterval(tick, 120);
};

window.cashout=(autoMode=false)=>{
  if(!running) { if(!autoMode) alert("è¿˜æ²¡å¼€å§‹"); return; }
  stop();

  const { winBoost } = vipParams();
  const win = Math.floor(stake * mult * winBoost);
  coin += win; save();

  msgEl.textContent = `âœ… æç°æˆåŠŸ +${win}ï¼ˆ${mult.toFixed(2)}xï¼‰`;
  targetEl.textContent = `CASHED @ ${mult.toFixed(2)}x`;

  // å†å²è®°å½•â€œå…‘ç°ç‚¹â€ä¸å†™å…¥ï¼Œä»å†™çˆ†ç‚¹ï¼ˆæ›´åƒå¹³å°ï¼‰
  const task = onPlay("crash");
  if(task.got>0) msgEl.textContent += ` ï½œâœ…ä»»åŠ¡ +${task.got}`;
};

</script>
</body>
</html>
