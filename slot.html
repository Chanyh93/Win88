<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WIN88 Â· Slots</title>
  <link rel="stylesheet" href="casino.css"/>
</head>
<body class="app">

<header class="appbar">
  <button class="iconBtn" onclick="location.href='index.html'">â€¹</button>
  <div class="brandCenter">
    <div class="brandMark">ğŸ°</div>
    <div class="brandText">Slots</div>
  </div>
  <button class="iconBtn" onclick="location.href='vip.html'">ğŸ‘‘</button>
</header>

<main class="container">
  <section class="walletCard">
    <div class="walletTop">
      <div class="walletTitle">Balance</div>
      <div class="walletActions">
        <button class="pillBtn" onclick="showPaytable()">Paytable</button>
        <button class="pillBtn" onclick="auto10()">Auto 10</button>
      </div>
    </div>
    <div class="walletBottom">
      <div class="balancePill">
        <span class="ccy">COIN</span>
        <span class="amt" id="coin">â€”</span>
      </div>
      <button class="syncBtn" onclick="spin()">SPIN</button>
    </div>
    <div class="subRow"><div class="muted" id="msg">Scatter â‰¥ 3 è§¦å‘ Free Spinsï¼ˆ8 æ¬¡ï¼‰</div></div>
  </section>

  <section class="walletCard" style="margin-top:12px">
    <div class="walletTop">
      <div class="walletTitle">Bet</div>
      <div class="walletActions" style="gap:8px">
        <button class="tab" onclick="setBet(20)">20</button>
        <button class="tab active" onclick="setBet(50)">50</button>
        <button class="tab" onclick="setBet(100)">100</button>
        <button class="tab" onclick="setBet(200)">200</button>
      </div>
    </div>

    <div id="grid" style="margin-top:12px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px"></div>

    <div class="subRow">
      <div class="muted">Free Spins: <b id="fs">0</b></div>
    </div>
  </section>

  <p class="legal">18+ å¨±ä¹ç”¨é€” Â· è™šæ‹Ÿå¨±ä¹å¸ Â· æ— çœŸå®èµŒåš/æ— å…‘ç°</p>
</main>

<script type="module">
import { getCoin, setCoin, onPlay, vipParams } from "./progress.js";

let coin = getCoin();
const coinEl = document.getElementById("coin");
const msgEl = document.getElementById("msg");
const gridEl = document.getElementById("grid");
const fsEl = document.getElementById("fs");

let bet = 50;
let freeSpins = 0;
let spinning = false;

// Symbols
const W="ğŸƒ";     // Wild
const S="ğŸ";     // Scatter
const A="7ï¸âƒ£";
const B="ğŸ’";
const C="â­";
const D="ğŸ’";
const E="ğŸ‹";

const reels = [
  [E,D,C,C,B,A,S,E,D,W], // æ¯åˆ—ä¸€ä¸ªâ€œå·â€
  [E,D,C,B,B,A,S,E,D,W],
  [E,D,C,B,A,A,S,E,D,W],
  [E,D,C,C,B,A,S,E,D,W],
  [E,D,C,B,B,A,S,E,D,W],
];

const pay = {
  [A]: {3:8, 4:20, 5:60},
  [B]: {3:6, 4:15, 5:45},
  [C]: {3:5, 4:12, 5:35},
  [D]: {3:4, 4:10, 5:28},
  [E]: {3:3, 4:8,  5:22},
  [S]: {3:0, 4:0,  5:0},
  [W]: {3:10,4:30, 5:80}, // Wild è‡ªå·±æˆçº¿ä¹Ÿç»™é«˜ç‚¹
};

// 5 æ¡åŸºç¡€çº¿ï¼ˆä¸­é—´ã€ä¸Šã€ä¸‹ã€Vã€å€’Vï¼‰
const lines = [
  [1,1,1,1,1],
  [0,0,0,0,0],
  [2,2,2,2,2],
  [0,1,2,1,0],
  [2,1,0,1,2],
];

function save(){ setCoin(coin); coinEl.textContent = coin; fsEl.textContent = freeSpins; }
save();

window.setBet = (v)=>{ bet=v; msgEl.textContent=`Bet set to ${bet}`; };

function pickFromReel(i){
  const r = reels[i];
  return r[Math.floor(Math.random()*r.length)];
}

function buildSpinGrid(){
  // è¿”å› 5x3ï¼šgrid[col][row]
  const g = Array.from({length:5}, ()=>Array.from({length:3}, ()=>""));
  for(let c=0;c<5;c++){
    for(let r=0;r<3;r++) g[c][r]=pickFromReel(c);
  }
  return g;
}

function renderGrid(g){
  gridEl.innerHTML="";
  // ä»¥è¡Œæ˜¾ç¤ºæ›´ç›´è§‚ï¼šrow 0..2ï¼Œcol 0..4
  for(let r=0;r<3;r++){
    for(let c=0;c<5;c++){
      const cell = document.createElement("div");
      cell.className="rowLine";
      cell.style.height="56px";
      cell.style.display="grid";
      cell.style.placeItems="center";
      cell.style.fontSize="26px";
      cell.textContent = g[c][r];
      gridEl.appendChild(cell);
    }
  }
}

function evalLineSymbols(symbols){
  // symbols: [s1..s5]
  // è§„åˆ™ï¼šä»å·¦èµ·è¿ç»­ç›¸åŒï¼ˆWild å¯æ›¿ä»£ï¼‰
  // å…ˆæ‰¾ç¬¬ä¸€ä¸ªéWildä½œä¸ºä¸»ç¬¦å·
  let base = symbols.find(x=>x!==W) || W;
  // Scatter ä¸å‚ä¸çº¿å¥–
  if(base===S) return {sym:null, count:0, mult:0};

  let count=0;
  for(let i=0;i<symbols.length;i++){
    const s = symbols[i];
    if(s===base || s===W){
      count++;
    }else{
      break;
    }
  }
  if(count>=3 && pay[base] && pay[base][count]){
    return {sym:base, count, mult:pay[base][count]};
  }
  return {sym:null, count:0, mult:0};
}

function countScatter(g){
  let n=0;
  for(let c=0;c<5;c++) for(let r=0;r<3;r++) if(g[c][r]===S) n++;
  return n;
}

function payout(g){
  let totalMult=0;
  const wins=[];
  for(const ln of lines){
    const symbols = ln.map((row, col)=> g[col][row]);
    const res = evalLineSymbols(symbols);
    if(res.mult>0){
      totalMult += res.mult;
      wins.push(`${res.sym}Ã—${res.count} (${res.mult}x)`);
    }
  }
  return { totalMult, wins };
}

async function animateSpin(){
  // ç®€å•åŠ¨ç”»ï¼šå¿«é€Ÿåˆ·æ–°å‡ æ¬¡
  for(let i=0;i<10;i++){
    renderGrid(buildSpinGrid());
    await new Promise(r=>setTimeout(r,60));
  }
}

window.showPaytable = ()=>{
  alert(
`Paytableï¼ˆå€ç‡ Ã— Betï¼‰
7ï¸âƒ£: 3=8x 4=20x 5=60x
ğŸ’: 3=6x 4=15x 5=45x
â­: 3=5x 4=12x 5=35x
ğŸ’: 3=4x 4=10x 5=28x
ğŸ‹: 3=3x 4=8x  5=22x
ğŸƒ(Wild): 3=10x 4=30x 5=80x
ğŸ Scatter â‰¥3ï¼šFree Spins +8`
  );
};

window.spin = async ()=>{
  if(spinning) return;
  spinning=true;

  const { costFactor, winBoost } = vipParams();
  const cost = (freeSpins>0) ? 0 : Math.floor(bet * costFactor);

  if(cost>0 && coin < cost){ alert("ä½™é¢ä¸è¶³"); spinning=false; return; }
  if(cost>0){ coin -= cost; }

  await animateSpin();
  const g = buildSpinGrid();
  renderGrid(g);

  // Scatter -> Free Spins
  const sc = countScatter(g);
  if(sc>=3){
    freeSpins += 8;
    msgEl.textContent = `ğŸ Scatter ${sc}ï¼Free Spins +8`;
  }

  // Line wins
  const res = payout(g);
  const win = Math.floor(bet * res.totalMult * winBoost);
  if(win>0){
    coin += win;
    msgEl.textContent = `ğŸ‰ Win +${win} ï½œ ${res.wins.join(" , ")}`;
  }else if(sc<3){
    msgEl.textContent = cost===0 ? `Free Spinâ€¦` : `No winï¼ˆæ‰£ ${cost}ï¼‰`;
  }

  // Free spin consume
  if(freeSpins>0){
    freeSpins -= 1;
  }

  save();

  const task = onPlay("slot");
  if(task.got>0) msgEl.textContent += ` ï½œâœ…ä»»åŠ¡ +${task.got}`;

  spinning=false;
};

window.auto10 = async ()=>{
  for(let i=0;i<10;i++){
    if(!spinning){
      await window.spin();
      await new Promise(r=>setTimeout(r,120));
    }
  }
};

// åˆå§‹æ¸²æŸ“
renderGrid(buildSpinGrid());
</script>
</body>
</html>
